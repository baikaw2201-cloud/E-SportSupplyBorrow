<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏µ‡∏¨‡∏≤</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
        * { font-family: 'Prompt', sans-serif; }
        .tab-active { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-primary:hover { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
        .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-borrowed { background: #dbeafe; color: #1e40af; }
        .status-returned { background: #d1fae5; color: #065f46; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .login-container { background: linear-gradient(135deg, #10b981 0%, #059669 100%); min-height: 100%; display: flex; align-items: center; justify-content: center; }
    </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50">
  <div id="app" class="h-full overflow-auto"><!-- Login Screen -->
   <div id="login-screen" class="login-container">
    <div class="w-full max-w-md px-6">
     <div class="bg-white rounded-2xl shadow-2xl overflow-hidden animate-fadeIn">
      <div class="bg-gradient-to-r from-emerald-500 to-teal-600 px-6 py-8 text-center">
       <div class="text-6xl mb-3">
        üèÄ
       </div>
       <h1 class="text-2xl font-bold text-white mb-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
       <p class="text-emerald-100">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</p>
      </div>
      <div class="p-8">
       <div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
        <div class="flex gap-3"><button type="button" id="btn-student-role" onclick="setUserRole('student')" class="flex-1 py-3 px-4 bg-emerald-100 hover:bg-emerald-200 border-2 border-emerald-500 text-emerald-700 rounded-xl font-medium transition-all"> üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô </button> <button type="button" id="btn-admin-role" onclick="setUserRole('admin')" class="flex-1 py-3 px-4 bg-gray-100 hover:bg-gray-200 border-2 border-gray-300 text-gray-700 rounded-xl font-medium transition-all"> üîê ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô </button>
        </div>
       </div>
       <form id="student-login-form" onsubmit="loginStudent(event)" class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label> <input type="text" id="student-name-input" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label> <input type="text" id="student-id-input" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
        </div><button type="submit" class="w-full py-3 btn-primary text-white rounded-xl font-semibold transition-all"> üîì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö </button>
       </form>
       <form id="admin-login-form" class="hidden space-y-4" onsubmit="loginAdmin(event)">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô *</label> <input type="password" id="admin-password-input" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
        </div><button type="submit" class="w-full py-3 bg-gray-800 hover:bg-gray-900 text-white rounded-xl font-semibold transition-all"> üîì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô </button>
       </form>
       <p class="text-center text-xs text-gray-500 mt-4">üí° Demo: ‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô = <strong>admin123</strong></p>
      </div>
     </div>
    </div>
   </div><!-- Main App (Hidden by default) -->
   <div id="main-app" class="hidden h-full flex flex-col"><!-- Header -->
    <header class="bg-white shadow-lg">
     <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
       <div class="flex items-center gap-3">
        <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg"><span class="text-2xl">üèÄ</span>
        </div>
        <div>
         <h1 id="site-title" class="text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏µ‡∏¨‡∏≤</h1>
         <p id="user-info" class="text-sm text-gray-500">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
        </div>
       </div><button onclick="logout()" class="flex items-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition-colors font-medium"> üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö </button>
      </div>
     </div>
    </header><!-- Navigation Tabs (Student Only) -->
    <nav id="student-nav" class="bg-white border-b">
     <div class="max-w-7xl mx-auto px-4">
      <div class="flex gap-2 py-3 overflow-x-auto"><button onclick="switchTab('borrow')" id="tab-borrow" class="tab-active px-6 py-2.5 rounded-full font-medium transition-all whitespace-nowrap"> üì¶ ‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå </button> <button onclick="switchTab('return')" id="tab-return" class="px-6 py-2.5 rounded-full font-medium bg-gray-100 hover:bg-gray-200 transition-all whitespace-nowrap"> üîÑ ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå </button> <button onclick="switchTab('history')" id="tab-history" class="px-6 py-2.5 rounded-full font-medium bg-gray-100 hover:bg-gray-200 transition-all whitespace-nowrap"> üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô </button>
      </div>
     </div>
    </nav><!-- Admin Dashboard Tab -->
    <nav id="admin-nav" class="hidden bg-white border-b">
     <div class="max-w-7xl mx-auto px-4">
      <div class="flex gap-2 py-3"><button onclick="switchAdminTab('dashboard')" id="tab-dashboard" class="tab-active px-6 py-2.5 rounded-full font-medium transition-all"> üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î </button> <button onclick="switchAdminTab('requests')" id="tab-requests" class="px-6 py-2.5 rounded-full font-medium bg-gray-100 hover:bg-gray-200 transition-all"> ‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô </button>
      </div>
     </div>
    </nav><!-- Main Content -->
    <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-6 overflow-auto"><!-- Student Tabs --> <!-- Borrow Tab -->
     <section id="content-borrow" class="space-y-6">
      <div class="text-center mb-8">
       <h2 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏µ‡∏¨‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h2>
       <p class="text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</p>
      </div>
      <div id="equipment-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"><!-- Equipment cards will be rendered here -->
      </div>
     </section><!-- Return Tab -->
     <section id="content-return" class="hidden space-y-6">
      <div class="text-center mb-8">
       <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏µ‡∏¨‡∏≤</h2>
       <p class="text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</p>
      </div>
      <div id="return-list" class="space-y-4"><!-- Return items will be rendered here -->
      </div>
     </section><!-- History Tab -->
     <section id="content-history" class="hidden space-y-6">
      <div class="text-center mb-8">
       <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
       <p class="text-gray-500">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
      </div>
      <div id="history-list" class="space-y-4"><!-- History items will be rendered here -->
      </div>
     </section><!-- Admin Dashboard -->
     <section id="content-dashboard" class="hidden space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
       <div class="bg-white rounded-xl p-6 shadow-md border-l-4 border-emerald-500">
        <p class="text-gray-600 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</p>
        <p id="stat-borrowed" class="text-4xl font-bold text-emerald-600">0</p>
       </div>
       <div class="bg-white rounded-xl p-6 shadow-md border-l-4 border-yellow-500">
        <p class="text-gray-600 text-sm">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
        <p id="stat-pending" class="text-4xl font-bold text-yellow-600">0</p>
       </div>
       <div class="bg-white rounded-xl p-6 shadow-md border-l-4 border-green-500">
        <p class="text-gray-600 text-sm">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
        <p id="stat-approved" class="text-4xl font-bold text-green-600">0</p>
       </div>
       <div class="bg-white rounded-xl p-6 shadow-md border-l-4 border-blue-500">
        <p class="text-gray-600 text-sm">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        <p id="stat-total" class="text-4xl font-bold text-blue-600">0</p>
       </div>
      </div>
     </section><!-- Admin Requests Tab -->
     <section id="content-requests" class="hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
      <div id="admin-pending-list" class="space-y-6"><!-- Pending returns will be rendered here -->
      </div>
     </section>
    </main>
   </div><!-- Borrow Modal -->
   <div id="borrow-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeBorrowModal()"></div>
    <div class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden animate-fadeIn">
     <div class="bg-gradient-to-r from-emerald-500 to-teal-600 px-6 py-4">
      <h3 class="text-xl font-bold text-white">‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
      <p id="modal-equipment-name" class="text-emerald-100 text-sm"></p>
     </div>
     <form id="borrow-form" class="p-6 space-y-4" onsubmit="submitBorrow(event)"><input type="hidden" id="selected-equipment-id">
      <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° *</label>
       <div class="flex items-center gap-3"><button type="button" onclick="adjustQuantity(-1)" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full text-xl font-bold">-</button> <input type="number" id="borrow-quantity" value="1" min="1" required readonly class="w-20 px-4 py-3 border border-gray-200 rounded-xl text-center font-bold"> <button type="button" onclick="adjustQuantity(1)" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full text-xl font-bold">+</button> <span id="available-count" class="text-sm text-gray-500"></span>
       </div>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡∏°‡∏≤‡∏Ñ‡∏∑‡∏ô *</label> <input type="date" id="return-date" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
      </div>
      <div class="flex gap-3 pt-4"><button type="button" onclick="closeBorrowModal()" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium transition-colors"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button type="submit" id="submit-borrow-btn" class="flex-1 px-4 py-3 btn-primary text-white rounded-xl font-medium transition-colors"> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° </button>
      </div>
     </form>
    </div>
   </div><!-- Return Modal -->
   <div id="return-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeReturnModal()"></div>
    <div class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden animate-fadeIn">
     <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4">
      <h3 class="text-xl font-bold text-white">‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
      <p id="return-modal-info" class="text-blue-100 text-sm"></p>
     </div>
     <form id="return-form" class="p-6 space-y-4"><input type="hidden" id="return-borrow-id">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô *</label>
       <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-emerald-500 transition-colors"><input type="file" id="return-photo" accept="image/*" capture="environment" required class="hidden" onchange="previewReturnPhoto(event)">
        <div id="photo-preview-container" class="hidden mb-4"><img id="photo-preview" class="max-h-48 mx-auto rounded-lg">
        </div><button type="button" onclick="document.getElementById('return-photo').click()" class="px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium transition-colors"> üì∑ <span id="photo-btn-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span> </button>
        <p id="photo-size-info" class="text-xs text-gray-500 mt-2"></p>
       </div>
      </div>
      <div class="flex gap-3 pt-4"><button type="button" onclick="closeReturnModal()" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium transition-colors"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button type="button" id="submit-return-btn" onclick="submitReturn()" class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-colors"> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô </button>
      </div>
     </form>
    </div>
   </div><!-- Image Preview Modal -->
   <div id="image-modal" class="fixed inset-0 z-[60] hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeImageModal()"></div>
    <div class="absolute inset-4 flex items-center justify-center">
     <div class="relative max-w-3xl max-h-full animate-fadeIn"><button onclick="closeImageModal()" class="absolute -top-12 right-0 w-10 h-10 bg-white rounded-full text-xl shadow-lg">√ó</button> <img id="preview-image" class="max-w-full max-h-[80vh] rounded-xl shadow-2xl">
     </div>
    </div>
   </div><!-- Toast Container -->
   <div id="toast-container" class="fixed top-24 right-4 z-[70] space-y-2"></div>
  </div>
  <script>
        // Global State
        let currentUser = null;
        let currentUserRole = null;
        let allBorrowRecords = [];
        let equipmentData = [
            { id: "basketball", name: "‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏™‡πÄ‡∏Å‡∏ï‡∏ö‡∏≠‡∏•", icon: "üèÄ", total: 10, available: 10 },
            { id: "football", name: "‡∏•‡∏π‡∏Å‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•", icon: "‚öΩ", total: 15, available: 15 },
            { id: "volleyball", name: "‡∏•‡∏π‡∏Å‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏¢‡πå‡∏ö‡∏≠‡∏•", icon: "üèê", total: 12, available: 12 },
            { id: "badminton", name: "‡πÑ‡∏°‡πâ‡πÅ‡∏ö‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡∏ô", icon: "üè∏", total: 20, available: 20 },
            { id: "tennis", name: "‡πÑ‡∏°‡πâ‡πÄ‡∏ó‡∏ô‡∏ô‡∏¥‡∏™", icon: "üéæ", total: 8, available: 8 },
            { id: "tabletennis", name: "‡πÑ‡∏°‡πâ‡∏õ‡∏¥‡∏á‡∏õ‡∏≠‡∏á", icon: "üèì", total: 16, available: 16 },
            { id: "baseball", name: "‡πÑ‡∏°‡πâ‡πÄ‡∏ö‡∏™‡∏ö‡∏≠‡∏•", icon: "‚öæ", total: 6, available: 6 },
            { id: "rugby", name: "‡∏•‡∏π‡∏Å‡∏£‡∏±‡∏Å‡∏ö‡∏µ‡πâ", icon: "üèà", total: 5, available: 5 },
            { id: "frisbee", name: "‡∏à‡∏≤‡∏ô‡∏£‡πà‡∏≠‡∏ô", icon: "ü•è", total: 10, available: 10 },
            { id: "jumprope", name: "‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î", icon: "ü™¢", total: 25, available: 25 }
        ];
        let selectedEquipment = null;
        let selectedUserRole = 'student';

        // ===== DATA SDK HANDLER =====
        const dataHandler = {
            onDataChanged(data) {
                allBorrowRecords = data;
                
                // Update available equipment count
                equipmentData.forEach(eq => {
                    eq.available = eq.total - allBorrowRecords.filter(r => r.equipmentId === eq.id && r.status === 'borrowed').length;
                });

                if (currentUserRole === 'admin') {
                    updateAdminDashboard();
                }
            }
        };

        // Initialize Data SDK
        async function initDataSDK() {
            if (!window.dataSdk) {
                console.error("Data SDK not available");
                return;
            }
            const result = await window.dataSdk.init(dataHandler);
            if (!result.isOk) {
                console.error("Failed to initialize Data SDK:", result.error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initDataSDK);

        // ===== LOGIN SYSTEM =====
        function setUserRole(role) {
            selectedUserRole = role;
            document.getElementById('btn-student-role').classList.toggle('bg-emerald-100', role === 'student');
            document.getElementById('btn-student-role').classList.toggle('border-emerald-500', role === 'student');
            document.getElementById('btn-student-role').classList.toggle('bg-gray-100', role !== 'student');
            document.getElementById('btn-student-role').classList.toggle('border-gray-300', role !== 'student');
            
            document.getElementById('btn-admin-role').classList.toggle('bg-emerald-100', role === 'admin');
            document.getElementById('btn-admin-role').classList.toggle('border-emerald-500', role === 'admin');
            document.getElementById('btn-admin-role').classList.toggle('bg-gray-100', role !== 'admin');
            document.getElementById('btn-admin-role').classList.toggle('border-gray-300', role !== 'admin');

            document.getElementById('student-login-form').classList.toggle('hidden', role !== 'student');
            document.getElementById('admin-login-form').classList.toggle('hidden', role !== 'admin');
        }

        function loginStudent(e) {
            e.preventDefault();
            const name = document.getElementById('student-name-input').value;
            const id = document.getElementById('student-id-input').value;

            if (!name || !id) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
                return;
            }

            currentUser = { name, id };
            currentUserRole = 'student';
            enterApp();
        }

        function loginAdmin(e) {
            e.preventDefault();
            const password = document.getElementById('admin-password-input').value;

            if (password !== 'admin123') {
                showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }

            currentUser = { name: 'Admin' };
            currentUserRole = 'admin';
            enterApp();
        }

        function enterApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            if (currentUserRole === 'student') {
                document.getElementById('student-nav').classList.remove('hidden');
                document.getElementById('admin-nav').classList.add('hidden');
                document.getElementById('user-info').textContent = `üë®‚Äçüéì ${currentUser.name} (${currentUser.id})`;
                renderEquipment();
            } else {
                document.getElementById('student-nav').classList.add('hidden');
                document.getElementById('admin-nav').classList.remove('hidden');
                document.getElementById('user-info').textContent = `üîê ${currentUser.name}`;
                updateAdminDashboard();
            }

            setMinReturnDate();
        }

        function logout() {
            currentUser = null;
            currentUserRole = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('student-name-input').value = '';
            document.getElementById('student-id-input').value = '';
            document.getElementById('admin-password-input').value = '';
            setUserRole('student');
        }

        // ===== STUDENT FUNCTIONS =====
        function renderEquipment() {
            const grid = document.getElementById('equipment-grid');
            grid.innerHTML = equipmentData.map(eq => `
                <div class="equipment-card bg-white rounded-2xl p-4 shadow-md card-hover cursor-pointer relative ${eq.available === 0 ? 'opacity-50' : ''}"
                     onclick="${eq.available > 0 ? `openBorrowModal('${eq.id}')` : 'showToast(\"‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏´‡∏°‡∏î\", \"error\")'}">
                    <div class="text-5xl mb-3 text-center">${eq.icon}</div>
                    <h3 class="font-semibold text-gray-800 text-center text-sm mb-2">${eq.name}</h3>
                    <div class="flex justify-center">
                        <span class="px-3 py-1 ${eq.available > 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'} rounded-full text-xs font-medium">
                            ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${eq.available}/${eq.total}
                        </span>
                    </div>
                    ${eq.available === 0 ? '<div class="absolute inset-0 bg-white/60 rounded-2xl flex items-center justify-center"><span class="text-red-600 font-bold">‡∏´‡∏°‡∏î</span></div>' : ''}
                </div>
            `).join('');
        }

        function switchTab(tab) {
            ['borrow', 'return', 'history'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
                document.getElementById(`tab-${t}`).classList.add('bg-gray-100');
                document.getElementById(`content-${t}`).classList.add('hidden');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('bg-gray-100');
            document.getElementById(`content-${tab}`).classList.remove('hidden');

            if (tab === 'return') renderReturnList();
            if (tab === 'history') renderHistory();
        }

        function openBorrowModal(equipmentId) {
            selectedEquipment = equipmentData.find(e => e.id === equipmentId);
            if (!selectedEquipment) return;

            document.getElementById('selected-equipment-id').value = equipmentId;
            document.getElementById('modal-equipment-name').textContent = `${selectedEquipment.icon} ${selectedEquipment.name}`;
            document.getElementById('borrow-quantity').value = 1;
            document.getElementById('borrow-quantity').max = selectedEquipment.available;
            document.getElementById('available-count').textContent = `(‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${selectedEquipment.available} ‡∏ä‡∏¥‡πâ‡∏ô)`;
            document.getElementById('borrow-modal').classList.remove('hidden');
        }

        function closeBorrowModal() {
            document.getElementById('borrow-modal').classList.add('hidden');
            document.getElementById('borrow-form').reset();
        }

        function adjustQuantity(delta) {
            const input = document.getElementById('borrow-quantity');
            const newVal = parseInt(input.value) + delta;
            if (newVal >= 1 && newVal <= selectedEquipment.available) {
                input.value = newVal;
            }
        }

        function setMinReturnDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('return-date').min = today;
        }

        async function submitBorrow(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-borrow-btn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                const equipmentId = document.getElementById('selected-equipment-id').value;
                const equipment = equipmentData.find(eq => eq.id === equipmentId);

                const record = {
                    equipmentId,
                    equipmentName: equipment.name,
                    equipmentIcon: equipment.icon,
                    studentName: currentUser.name,
                    studentId: currentUser.id,
                    quantity: parseInt(document.getElementById('borrow-quantity').value),
                    returnDate: document.getElementById('return-date').value,
                    borrowDate: new Date().toISOString(),
                    status: 'borrowed',
                    returnPhoto: '',
                    actualReturnDate: ''
                };

                const createResult = await window.dataSdk.create(record);
                if (!createResult.isOk) {
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + createResult.error.message, 'error');
                    btn.disabled = false;
                    btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°';
                    return;
                }

                renderEquipment();
                closeBorrowModal();
                showToast('‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (error) {
                console.error('Error submitting borrow:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°';
            }
        }

        function renderReturnList() {
            const list = document.getElementById('return-list');
            const borrowedItems = allBorrowRecords.filter(r => r.status === 'borrowed' && r.studentId === currentUser.id);

            if (borrowedItems.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-2xl">
                        <div class="text-6xl mb-4">üì¶</div>
                        <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = borrowedItems.map(record => `
                <div class="bg-white rounded-xl p-4 shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="text-4xl">${record.equipmentIcon}</div>
                            <div>
                                <h4 class="font-semibold text-gray-800">${record.equipmentName} x${record.quantity}</h4>
                                <p class="text-xs text-gray-400">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatDate(record.returnDate)}</p>
                            </div>
                        </div>
                        <button onclick="openReturnModal('${record.__backendId}')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                            ‡∏Ñ‡∏∑‡∏ô
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openReturnModal(borrowId) {
            const record = allBorrowRecords.find(r => r.__backendId === borrowId);
            if (!record) return;

            document.getElementById('return-borrow-id').value = borrowId;
            document.getElementById('return-modal-info').textContent = `${record.equipmentIcon} ${record.equipmentName} x${record.quantity}`;
            document.getElementById('photo-preview-container').classList.add('hidden');
            document.getElementById('photo-btn-text').textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
            document.getElementById('photo-size-info').textContent = '';
            document.getElementById('return-form').reset();
            document.getElementById('return-modal').classList.remove('hidden');
        }

        function closeReturnModal() {
            document.getElementById('return-modal').classList.add('hidden');
            document.getElementById('return-form').reset();
        }

        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onerror = function() {
                    console.error('Failed to load image');
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'error');
                    callback(null);
                };
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î - ‡πÉ‡∏´‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 500px
                        const maxDimension = 500;
                        if (width > height) {
                            if (width > maxDimension) {
                                height = Math.round((height * maxDimension) / width);
                                width = maxDimension;
                            }
                        } else {
                            if (height > maxDimension) {
                                width = Math.round((width * maxDimension) / height);
                                height = maxDimension;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î JPEG ‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏•‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏ü‡∏•‡πå < 40KB
                        let quality = 0.65;
                        let compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        let iterations = 0;
                        
                        // ‡∏•‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏∞‡∏û‡∏≠
                        while (compressedDataUrl.length > 40000 && quality > 0.15 && iterations < 20) {
                            quality -= 0.05;
                            compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                            iterations++;
                        }
                        
                        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡πÉ‡∏´‡πâ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                        if (compressedDataUrl.length > 40000 && width > 300) {
                            canvas.width = Math.round(width * 0.6);
                            canvas.height = Math.round(height * 0.6);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            quality = 0.5;
                            compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                            
                            while (compressedDataUrl.length > 40000 && quality > 0.15) {
                                quality -= 0.05;
                                compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                            }
                        }
                        
                        console.log('Original:', file.size, 'bytes | Compressed:', compressedDataUrl.length, 'bytes');
                        callback(compressedDataUrl);
                    } catch (error) {
                        console.error('Compression error:', error);
                        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ', 'error');
                        callback(null);
                    }
                };
                img.src = event.target.result;
            };
            reader.onerror = function() {
                console.error('Failed to read file');
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
                callback(null);
            };
            reader.readAsDataURL(file);
        }

        function previewReturnPhoto(e) {
            const file = e.target.files[0];
            if (!file) return;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå
            if (!file.type.startsWith('image/')) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                document.getElementById('return-photo').value = '';
                return;
            }

            const btn = document.getElementById('photo-btn-text').parentElement.parentElement;
            const originalText = document.getElementById('photo-btn-text').textContent;
            document.getElementById('photo-btn-text').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î...';

            compressImage(file, (compressedDataUrl) => {
                if (!compressedDataUrl) {
                    document.getElementById('photo-btn-text').textContent = originalText;
                    document.getElementById('return-photo').value = '';
                    return;
                }

                try {
                    document.getElementById('photo-preview').src = compressedDataUrl;
                    document.getElementById('photo-preview-container').classList.remove('hidden');
                    document.getElementById('photo-btn-text').textContent = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ';
                    document.getElementById('return-photo').dataset.compressed = compressedDataUrl;
                    
                    const sizeKB = (compressedDataUrl.length / 1024).toFixed(1);
                    document.getElementById('photo-size-info').textContent = `‚úÖ ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${sizeKB} KB) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á`;
                } catch (error) {
                    console.error('Preview error:', error);
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ', 'error');
                    document.getElementById('photo-btn-text').textContent = originalText;
                }
            });
        }

        async function submitReturn() {
            const btn = document.getElementById('submit-return-btn');
            
            const borrowId = document.getElementById('return-borrow-id').value;
            const compressedPhoto = document.getElementById('return-photo').dataset.compressed;
            
            if (!borrowId) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', 'error');
                return;
            }

            if (!compressedPhoto) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error');
                return;
            }

            const record = allBorrowRecords.find(r => r.__backendId === borrowId);
            if (!record) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                const updatedRecord = {
                    ...record,
                    status: 'pending',
                    returnPhoto: compressedPhoto,
                    actualReturnDate: new Date().toISOString()
                };

                const updateResult = await window.dataSdk.update(updatedRecord);
                if (!updateResult.isOk) {
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + updateResult.error.message, 'error');
                    btn.disabled = false;
                    btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô';
                    return;
                }

                closeReturnModal();
                renderReturnList();
                showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
            } catch (error) {
                console.error("Submit return error:", error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô';
            }
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const myRecords = allBorrowRecords.filter(r => r.studentId === currentUser.id);

            if (myRecords.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-2xl">
                        <div class="text-6xl mb-4">üìã</div>
                        <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = myRecords.map(record => `
                <div class="bg-white rounded-xl p-4 shadow-md">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center gap-3">
                            <div class="text-4xl">${record.equipmentIcon}</div>
                            <div>
                                <h4 class="font-semibold text-gray-800">${record.equipmentName} x${record.quantity}</h4>
                                <p class="text-xs text-gray-400">‡∏¢‡∏∑‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDate(record.borrowDate)}</p>
                                <p class="text-xs text-gray-400">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatDate(record.returnDate)}</p>
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(record.status)}">
                            ${getStatusText(record.status)}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // ===== ADMIN FUNCTIONS =====
        function switchAdminTab(tab) {
            ['dashboard', 'requests'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
                document.getElementById(`tab-${t}`).classList.add('bg-gray-100');
                document.getElementById(`content-${t}`).classList.add('hidden');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('bg-gray-100');
            document.getElementById(`content-${tab}`).classList.remove('hidden');

            if (tab === 'requests') renderAdminPending();
        }

        function updateAdminDashboard() {
            const borrowed = allBorrowRecords.filter(r => r.status === 'borrowed').length;
            const pending = allBorrowRecords.filter(r => r.status === 'pending').length;
            const approved = allBorrowRecords.filter(r => r.status === 'approved').length;

            document.getElementById('stat-borrowed').textContent = borrowed;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-approved').textContent = approved;
            document.getElementById('stat-total').textContent = allBorrowRecords.length;
        }

        function renderAdminPending() {
            const list = document.getElementById('admin-pending-list');
            const borrowed = allBorrowRecords.filter(r => r.status === 'borrowed');
            const pending = allBorrowRecords.filter(r => r.status === 'pending');

            let html = '';

            if (borrowed.length > 0) {
                html += '<div class="mb-8"><h3 class="text-lg font-bold text-gray-800 mb-4">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà</h3>';
                html += borrowed.map(record => `
                    <div class="bg-blue-50 rounded-xl p-4 shadow-md mb-3 border-l-4 border-blue-500">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center gap-3">
                                <div class="text-4xl">${record.equipmentIcon}</div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">${record.equipmentName} x${record.quantity}</h4>
                                    <p class="text-sm text-gray-600">üë§ ${record.studentName} (${record.studentId})</p>
                                    <p class="text-xs text-gray-500">üìÖ ‡∏¢‡∏∑‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDateTime(record.borrowDate)}</p>
                                    <p class="text-xs text-gray-500">üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatDate(record.returnDate)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                html += '</div>';
            }

            if (pending.length > 0) {
                html += '<div><h3 class="text-lg font-bold text-gray-800 mb-4">‚è≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</h3>';
                html += pending.map(record => `
                    <div class="bg-yellow-50 rounded-xl p-4 shadow-md mb-3 border-l-4 border-yellow-500">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="text-4xl">${record.equipmentIcon}</div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">${record.equipmentName} x${record.quantity}</h4>
                                    <p class="text-sm text-gray-600">üë§ ${record.studentName} (${record.studentId})</p>
                                    <p class="text-xs text-gray-500">üìÖ ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDateTime(record.actualReturnDate)}</p>
                                </div>
                            </div>
                        </div>
                        ${record.returnPhoto ? `
                            <button onclick="showImage('${record.returnPhoto.replace(/'/g, "\\'")}')" class="mb-3 w-full text-sm text-blue-600 hover:text-blue-800 font-medium py-2 bg-white border border-blue-300 rounded-lg transition-colors">
                                üì∑ ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô
                            </button>
                        ` : ''}
                        <button onclick="approveReturn('${record.__backendId}')" class="w-full py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors">
                            ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô
                        </button>
                    </div>
                `).join('');
                html += '</div>';
            }

            if (borrowed.length === 0 && pending.length === 0) {
                html = `
                    <div class="text-center py-12 bg-white rounded-2xl">
                        <div class="text-6xl mb-4">‚úÖ</div>
                        <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                    </div>
                `;
            }

            list.innerHTML = html;
        }

        async function approveReturn(borrowId) {
            const record = allBorrowRecords.find(r => r.__backendId === borrowId);
            if (!record) return;

            try {
                const updatedRecord = {
                    ...record,
                    status: 'approved'
                };

                const updateResult = await window.dataSdk.update(updatedRecord);
                if (!updateResult.isOk) {
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ' + updateResult.error.message, 'error');
                    return;
                }

                renderAdminPending();
                updateAdminDashboard();
                showToast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (error) {
                console.error('Error approving return:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }

        // ===== COMMON FUNCTIONS =====
        function showImage(url) {
            document.getElementById('preview-image').src = url;
            document.getElementById('image-modal').classList.remove('hidden');
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.add('hidden');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', { 
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function getStatusClass(status) {
            const classes = {
                borrowed: 'status-borrowed',
                pending: 'status-pending',
                approved: 'status-returned',
                returned: 'status-returned'
            };
            return classes[status] || 'bg-gray-100 text-gray-700';
        }

        function getStatusText(status) {
            const texts = {
                borrowed: 'üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°',
                pending: '‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                approved: '‚úÖ ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                returned: '‚úÖ ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
            };
            return texts[status] || status;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            
            toast.className = `toast ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Initialize
        setUserRole('student');
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cd30c6d8426fdc5',t:'MTc3MDk3MjMxNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
