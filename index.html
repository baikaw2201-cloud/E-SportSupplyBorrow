<!doctype html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏µ‡∏¨‡∏≤ | Sports System</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.10.1/dist/compressor.min.js"></script>

    <style>
        * { font-family: 'Prompt', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .tab-active { background: #3b82f6; color: white; transform: scale(1.02); }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="h-full bg-gray-50 text-gray-800">

<div id="app" class="h-full flex flex-col">
    <header class="gradient-bg text-white shadow-lg p-5">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-white/20 rounded-lg text-2xl">‚öΩ</div>
                <h1 class="text-xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏µ‡∏¨‡∏≤</h1>
            </div>
            <button onclick="toggleAdmin()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm border border-white/30 transition-all">üîê ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
        </div>
    </header>

    <nav class="bg-white border-b sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 py-3 flex gap-2 overflow-x-auto">
            <button class="tab-btn tab-active px-6 py-2.5 rounded-xl font-semibold transition-all shadow-sm" data-tab="borrow" onclick="switchTab('borrow')">üì¶ ‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
            <button class="tab-btn bg-gray-100 px-6 py-2.5 rounded-xl font-semibold transition-all text-gray-500" data-tab="return" onclick="switchTab('return')">üîÑ ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
            <button id="admin-tab" class="tab-btn hidden bg-purple-100 text-purple-700 px-6 py-2.5 rounded-xl font-semibold transition-all" data-tab="admin" onclick="switchTab('admin')">üë®‚Äçüíº ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </nav>

    <main class="flex-1 max-w-7xl mx-auto px-4 py-6 w-full">
        <section id="borrow-section" class="tab-content">
            <div id="equipment-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                </div>
        </section>

        <section id="return-section" class="tab-content hidden">
            <div class="max-w-md mx-auto bg-white p-6 rounded-2xl shadow-sm border mb-6 text-center">
                <h2 class="text-lg font-bold mb-4">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
                <div class="flex gap-2">
                    <input type="text" id="search-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." class="flex-1 px-4 py-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    <button onclick="searchMyBorrows()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition-all">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
            </div>
            <div id="student-list" class="space-y-3"></div>
        </section>

        <section id="admin-section" class="tab-content hidden">
            <h2 class="text-xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏ô</h2>
            <div id="admin-list" class="space-y-3"></div>
        </section>
    </main>
</div>

<div id="borrow-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-backdrop absolute inset-0" onclick="closeModal('borrow-modal')"></div>
    <div class="bg-white rounded-3xl w-full max-w-md relative overflow-hidden">
        <div class="gradient-bg p-6 text-white text-center">
            <h3 class="text-xl font-bold" id="modal-title">‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
        </div>
        <form id="borrow-form" class="p-6 space-y-4">
            <input type="hidden" id="modal-eq-id">
            <input type="text" id="std-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required class="w-full px-4 py-3 bg-gray-50 border rounded-xl outline-none focus:border-blue-500">
            <input type="text" id="std-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" required class="w-full px-4 py-3 bg-gray-50 border rounded-xl outline-none focus:border-blue-500">
            <div class="flex gap-2 pt-2">
                <button type="button" onclick="closeModal('borrow-modal')" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</button>
            </div>
        </form>
    </div>
</div>

<div id="return-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-backdrop absolute inset-0" onclick="closeModal('return-modal')"></div>
    <div class="bg-white rounded-3xl w-full max-w-md relative overflow-hidden">
        <div class="bg-purple-600 p-6 text-white text-center">
            <h3 class="text-xl font-bold">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</h3>
        </div>
        <form id="return-form" class="p-6 space-y-4">
            <input type="hidden" id="return-doc-id">
            <div class="border-2 border-dashed border-gray-300 rounded-2xl p-4 text-center cursor-pointer hover:bg-gray-50" onclick="document.getElementById('file-input').click()">
                <input type="file" id="file-input" accept="image/*" capture="environment" class="hidden" onchange="previewImage(event)">
                <div id="preview-container" class="hidden">
                    <img id="img-show" class="max-h-48 mx-auto rounded-lg mb-2">
                    <p class="text-green-600 text-sm font-bold">‚úì ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</p>
                </div>
                <div id="placeholder">
                    <p class="text-4xl mb-2">üì∑</p>
                    <p class="text-gray-500 font-medium">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</p>
                </div>
            </div>
            <button type="submit" id="submit-return-btn" class="w-full py-4 bg-purple-600 text-white rounded-2xl font-bold shadow-lg">üöÄ ‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</button>
        </form>
    </div>
</div>

<script>
    // 1. Firebase Configuration (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    const firebaseConfig = {
        apiKey: "AIzaSy...",
        authDomain: "your-project.firebaseapp.com",
        projectId: "your-project",
        storageBucket: "your-project.firebasestorage.app",
        appId: "your-app-id"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
    const items = [
        { id: 'ball1', name: '‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•', icon: '‚öΩ' },
        { id: 'ball2', name: '‡∏ö‡∏≤‡∏™‡πÄ‡∏Å‡∏ï‡∏ö‡∏≠‡∏•', icon: 'üèÄ' },
        { id: 'ball3', name: '‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏¢‡πå‡∏ö‡∏≠‡∏•', icon: 'üèê' },
        { id: 'ball4', name: '‡πÅ‡∏ö‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡∏ô', icon: 'üè∏' }
    ];

    let compressedFile = null;

    // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
    function init() {
        const grid = document.getElementById('equipment-grid');
        grid.innerHTML = items.map(item => `
            <div onclick="openBorrow('${item.id}', '${item.name}')" class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm text-center cursor-pointer hover:shadow-md transition-all">
                <div class="text-5xl mb-3">${item.icon}</div>
                <h3 class="font-bold">${item.name}</h3>
                <p class="text-blue-500 text-sm mt-1">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏°</p>
            </div>
        `).join('');
    }

    // 4. ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°
    function openBorrow(id, name) {
        document.getElementById('modal-eq-id').value = id;
        document.getElementById('modal-title').innerText = '‡∏¢‡∏∑‡∏°' + name;
        document.getElementById('borrow-modal').classList.remove('hidden');
    }

    document.getElementById('borrow-form').onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            equipmentId: document.getElementById('modal-eq-id').value,
            studentName: document.getElementById('std-name').value,
            studentId: document.getElementById('std-id').value,
            status: 'borrowed',
            borrowDate: new Date()
        };
        try {
            await db.collection('borrows').add(data);
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            closeModal('borrow-modal');
        } catch (err) { alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); }
    };

    // 5. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∑‡∏ô (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ)
    async function searchMyBorrows() {
        const sid = document.getElementById('search-input').value;
        const snap = await db.collection('borrows').where('studentId', '==', sid).where('status', '==', 'borrowed').get();
        const list = document.getElementById('student-list');
        
        if(snap.empty) { list.innerHTML = '<p class="text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</p>'; return; }

        list.innerHTML = snap.docs.map(doc => {
            const d = doc.data();
            const item = items.find(i => i.id === d.equipmentId);
            return `
                <div class="bg-white p-4 rounded-xl border flex justify-between items-center">
                    <div><p class="font-bold">${item.name}</p><p class="text-xs text-gray-500">‡∏¢‡∏∑‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${d.borrowDate.toDate().toLocaleDateString()}</p></div>
                    <button onclick="openReturnModal('${doc.id}')" class="bg-purple-600 text-white px-5 py-2 rounded-lg font-bold">‡∏Ñ‡∏∑‡∏ô</button>
                </div>
            `;
        }).join('');
    }

    function openReturnModal(id) {
        document.getElementById('return-doc-id').value = id;
        document.getElementById('return-modal').classList.remove('hidden');
    }

    function previewImage(e) {
        const file = e.target.files[0];
        if (file) {
            new Compressor(file, {
                quality: 0.6,
                success(res) {
                    compressedFile = res;
                    document.getElementById('img-show').src = URL.createObjectURL(res);
                    document.getElementById('preview-container').classList.remove('hidden');
                    document.getElementById('placeholder').classList.add('hidden');
                }
            });
        }
    }

    document.getElementById('return-form').onsubmit = async (e) => {
        e.preventDefault();
        if(!compressedFile) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô');
        
        const btn = document.getElementById('submit-return-btn');
        const id = document.getElementById('return-doc-id').value;

        try {
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

            // Upload Image to Firebase Storage
            const ref = storage.ref(`returns/${id}_${Date.now()}.jpg`);
            const task = await ref.put(compressedFile);
            const photoUrl = await task.ref.getDownloadURL();

            // Update Database
            await db.collection('borrows').doc(id).update({
                status: 'pending',
                photoUrl: photoUrl,
                returnDate: new Date()
            });

            alert('‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
            closeModal('return-modal');
            searchMyBorrows();
        } catch (err) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); }
        finally { btn.disabled = false; btn.innerText = 'üöÄ ‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô'; }
    };

    // 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°
    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(tab + '-section').classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('tab-active', 'bg-blue-600', 'text-white');
            b.classList.add('bg-gray-100', 'text-gray-500');
        });
        const active = document.querySelector(`[data-tab="${tab}"]`);
        active.classList.add('tab-active');
        active.classList.remove('bg-gray-100', 'text-gray-500');
    }

    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    function toggleAdmin() {
        const pw = prompt('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:');
        if(pw === '1234') {
            document.getElementById('admin-tab').classList.remove('hidden');
            switchTab('admin');
            loadAdminData();
        }
    }

    async function loadAdminData() {
        const snap = await db.collection('borrows').where('status', '==', 'pending').get();
        const list = document.getElementById('admin-list');
        list.innerHTML = snap.docs.map(doc => {
            const d = doc.data();
            return `
                <div class="bg-white p-4 rounded-xl border flex flex-col gap-3">
                    <div class="flex justify-between">
                        <p class="font-bold">${d.studentName} (${d.studentId})</p>
                        <button onclick="window.open('${d.photoUrl}')" class="text-blue-600 text-sm font-bold underline">‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</button>
                    </div>
                    <button onclick="approve('${doc.id}')" class="w-full py-2 bg-green-500 text-white rounded-lg font-bold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏ô</button>
                </div>
            `;
        }).join('');
    }

    async function approve(id) {
        await db.collection('borrows').doc(id).update({ status: 'returned' });
        alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß'); loadAdminData();
    }

    init();
</script>
</body>
</html>
