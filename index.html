<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏µ‡∏¨‡∏≤</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
        * { font-family: 'Prompt', sans-serif; }
        .tab-active { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-primary:hover { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
        .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-borrowed { background: #dbeafe; color: #1e40af; }
        .status-returned { background: #d1fae5; color: #065f46; }
        .status-approved { background: #dcfce7; color: #166534; }
        .equipment-card { transition: all 0.3s ease; }
        .quantity-badge { position: absolute; top: -8px; right: -8px; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50">
  <div id="app" class="h-full overflow-auto"><!-- Header -->
   <header class="bg-white shadow-lg sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4">
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg"><span class="text-2xl">üèÄ</span>
       </div>
       <div>
        <h1 id="site-title" class="text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏µ‡∏¨‡∏≤</h1>
        <p id="school-name" class="text-sm text-gray-500">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
       </div>
      </div><button onclick="toggleAdminPanel()" class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"> <span>üë§</span> <span class="hidden sm:inline text-sm font-medium">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</span> </button>
     </div>
    </div>
   </header><!-- Navigation Tabs -->
   <nav class="bg-white border-b sticky top-20 z-30">
    <div class="max-w-7xl mx-auto px-4">
     <div class="flex gap-2 py-3 overflow-x-auto"><button onclick="switchTab('borrow')" id="tab-borrow" class="tab-active px-6 py-2.5 rounded-full font-medium transition-all whitespace-nowrap"> üì¶ ‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå </button> <button onclick="switchTab('return')" id="tab-return" class="px-6 py-2.5 rounded-full font-medium bg-gray-100 hover:bg-gray-200 transition-all whitespace-nowrap"> üîÑ ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå </button> <button onclick="switchTab('history')" id="tab-history" class="px-6 py-2.5 rounded-full font-medium bg-gray-100 hover:bg-gray-200 transition-all whitespace-nowrap"> üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô </button>
     </div>
    </div>
   </nav><!-- Main Content -->
   <main class="max-w-7xl mx-auto px-4 py-6"><!-- Borrow Tab -->
    <section id="content-borrow" class="space-y-6">
     <div class="text-center mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏µ‡∏¨‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h2>
      <p class="text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</p>
     </div>
     <div id="equipment-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"><!-- Equipment cards will be rendered here -->
     </div>
    </section><!-- Return Tab -->
    <section id="content-return" class="hidden space-y-6">
     <div class="text-center mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏µ‡∏¨‡∏≤</h2>
      <p class="text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</p>
     </div>
     <div id="return-list" class="space-y-4"><!-- Return items will be rendered here -->
     </div>
    </section><!-- History Tab -->
    <section id="content-history" class="hidden space-y-6">
     <div class="text-center mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h2>
      <p class="text-gray-500">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
     </div>
     <div class="mb-4"><input type="text" id="history-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." class="w-full max-w-md px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent" oninput="filterHistory()">
     </div>
     <div id="history-list" class="space-y-4"><!-- History items will be rendered here -->
     </div>
    </section>
   </main><!-- Borrow Modal -->
   <div id="borrow-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeBorrowModal()"></div>
    <div class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden animate-fadeIn">
     <div class="bg-gradient-to-r from-emerald-500 to-teal-600 px-6 py-4">
      <h3 class="text-xl font-bold text-white">‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
      <p id="modal-equipment-name" class="text-emerald-100 text-sm"></p>
     </div>
     <form id="borrow-form" class="p-6 space-y-4" onsubmit="submitBorrow(event)"><input type="hidden" id="selected-equipment-id">
      <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label> <input type="text" id="student-name" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label> <input type="text" id="student-id" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° *</label>
       <div class="flex items-center gap-3"><button type="button" onclick="adjustQuantity(-1)" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full text-xl font-bold">-</button> <input type="number" id="borrow-quantity" value="1" min="1" required readonly class="w-20 px-4 py-3 border border-gray-200 rounded-xl text-center font-bold"> <button type="button" onclick="adjustQuantity(1)" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full text-xl font-bold">+</button> <span id="available-count" class="text-sm text-gray-500"></span>
       </div>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡∏°‡∏≤‡∏Ñ‡∏∑‡∏ô *</label> <input type="date" id="return-date" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
      </div>
      <div class="flex gap-3 pt-4"><button type="button" onclick="closeBorrowModal()" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium transition-colors"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button type="submit" id="submit-borrow-btn" class="flex-1 px-4 py-3 btn-primary text-white rounded-xl font-medium transition-colors"> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° </button>
      </div>
     </form>
    </div>
   </div><!-- Return Modal -->
   <div id="return-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeReturnModal()"></div>
    <div class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden animate-fadeIn">
     <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4">
      <h3 class="text-xl font-bold text-white">‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
      <p id="return-modal-info" class="text-blue-100 text-sm"></p>
     </div>
     <form id="return-form" class="p-6 space-y-4"><input type="hidden" id="return-borrow-id">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô *</label>
       <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-emerald-500 transition-colors"><input type="file" id="return-photo" accept="image/*" capture="environment" required class="hidden" onchange="previewReturnPhoto(event)">
        <div id="photo-preview-container" class="hidden mb-4"><img id="photo-preview" class="max-h-48 mx-auto rounded-lg">
        </div><button type="button" onclick="document.getElementById('return-photo').click()" class="px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium transition-colors"> üì∑ <span id="photo-btn-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span> </button>
       </div>
      </div>
      <div class="flex gap-3 pt-4"><button type="button" onclick="closeReturnModal()" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium transition-colors"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button type="button" id="submit-return-btn" onclick="submitReturn()" class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-colors"> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô </button>
      </div>
     </form>
    </div>
   </div><!-- Admin Panel -->
   <div id="admin-panel" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="toggleAdminPanel()"></div>
    <div class="absolute inset-0 sm:inset-4 sm:left-auto sm:w-full sm:max-w-2xl bg-white shadow-2xl overflow-hidden animate-fadeIn sm:rounded-2xl">
     <div class="bg-gradient-to-r from-gray-800 to-gray-900 px-6 py-4 flex items-center justify-between">
      <div>
       <h3 class="text-xl font-bold text-white">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
       <p class="text-gray-400 text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p>
      </div><button onclick="toggleAdminPanel()" class="w-10 h-10 bg-gray-700 hover:bg-gray-600 rounded-full text-white text-xl">√ó</button>
     </div>
     <div class="p-4 border-b bg-gray-50">
      <div class="flex gap-2 flex-wrap"><button onclick="filterAdmin('all')" class="admin-filter px-4 py-2 bg-gray-800 text-white rounded-lg text-sm font-medium" data-filter="all"> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î </button> <button onclick="filterAdmin('borrowed')" class="admin-filter px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium" data-filter="borrowed"> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏° </button> <button onclick="filterAdmin('pending')" class="admin-filter px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium" data-filter="pending"> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ </button> <button onclick="filterAdmin('approved')" class="admin-filter px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium" data-filter="approved"> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß </button>
      </div>
     </div>
     <div id="admin-list" class="overflow-y-auto" style="height: calc(100% - 140px);"><!-- Admin list will be rendered here -->
     </div>
    </div>
   </div><!-- Image Preview Modal -->
   <div id="image-modal" class="fixed inset-0 z-[60] hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeImageModal()"></div>
    <div class="absolute inset-4 flex items-center justify-center">
     <div class="relative max-w-3xl max-h-full animate-fadeIn"><button onclick="closeImageModal()" class="absolute -top-12 right-0 w-10 h-10 bg-white rounded-full text-xl shadow-lg">√ó</button> <img id="preview-image" class="max-w-full max-h-[80vh] rounded-xl shadow-2xl">
     </div>
    </div>
   </div><!-- Toast Container -->
   <div id="toast-container" class="fixed top-24 right-4 z-[70] space-y-2"></div>
  </div>
  <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCcPHPBC3GYPB2UZIrlfOOuf6nZh_giAk",
            authDomain: "e-sportsupply-borrowing.firebaseapp.com",
            databaseURL: "https://e-sportsupply-borrowing-default-rtdb.firebaseio.com",
            projectId: "e-sportsupply-borrowing",
            storageBucket: "e-sportsupply-borrowing.firebasestorage.app",
            messagingSenderId: "572790206354",
            appId: "1:572790206354:web:8fb3a3c220494554b8db4b",
            measurementId: "G-NC0WZTT9R6"
        };

        // Initialize Firebase
        let db, storage;
        let isFirebaseInitialized = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
            isFirebaseInitialized = true;
            console.log("Firebase initialized successfully!");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // Default Config
        const defaultConfig = {
            site_title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏µ‡∏¨‡∏≤",
            school_name: "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"
        };

        // Equipment Data
        const equipmentData = [
            { id: "basketball", name: "‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏™‡πÄ‡∏Å‡∏ï‡∏ö‡∏≠‡∏•", icon: "üèÄ", total: 10, available: 10 },
            { id: "football", name: "‡∏•‡∏π‡∏Å‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•", icon: "‚öΩ", total: 15, available: 15 },
            { id: "volleyball", name: "‡∏•‡∏π‡∏Å‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏¢‡πå‡∏ö‡∏≠‡∏•", icon: "üèê", total: 12, available: 12 },
            { id: "badminton", name: "‡πÑ‡∏°‡πâ‡πÅ‡∏ö‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡∏ô", icon: "üè∏", total: 20, available: 20 },
            { id: "tennis", name: "‡πÑ‡∏°‡πâ‡πÄ‡∏ó‡∏ô‡∏ô‡∏¥‡∏™", icon: "üéæ", total: 8, available: 8 },
            { id: "tabletennis", name: "‡πÑ‡∏°‡πâ‡∏õ‡∏¥‡∏á‡∏õ‡∏≠‡∏á", icon: "üèì", total: 16, available: 16 },
            { id: "baseball", name: "‡πÑ‡∏°‡πâ‡πÄ‡∏ö‡∏™‡∏ö‡∏≠‡∏•", icon: "‚öæ", total: 6, available: 6 },
            { id: "rugby", name: "‡∏•‡∏π‡∏Å‡∏£‡∏±‡∏Å‡∏ö‡∏µ‡πâ", icon: "üèà", total: 5, available: 5 },
            { id: "frisbee", name: "‡∏à‡∏≤‡∏ô‡∏£‡πà‡∏≠‡∏ô", icon: "ü•è", total: 10, available: 10 },
            { id: "jumprope", name: "‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î", icon: "ü™¢", total: 25, available: 25 }
        ];

        let currentEquipment = [...equipmentData];
        let borrowRecords = [];
        let currentAdminFilter = 'all';
        let selectedEquipment = null;

        // Element SDK Integration
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange: async (config) => {
                    document.getElementById('site-title').textContent = config.site_title || defaultConfig.site_title;
                    document.getElementById('school-name').textContent = config.school_name || defaultConfig.school_name;
                },
                mapToCapabilities: (config) => ({
                    recolorables: [],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["site_title", config.site_title || defaultConfig.site_title],
                    ["school_name", config.school_name || defaultConfig.school_name]
                ])
            });
        }

        // Initialize App
        async function initApp() {
            renderEquipment();
            await loadBorrowRecords();
            setMinReturnDate();
        }

        // Set minimum return date to today
        function setMinReturnDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('return-date').min = today;
        }

        // Render Equipment Grid
        function renderEquipment() {
            const grid = document.getElementById('equipment-grid');
            grid.innerHTML = currentEquipment.map(eq => `
                <div class="equipment-card bg-white rounded-2xl p-4 shadow-md card-hover cursor-pointer relative ${eq.available === 0 ? 'opacity-50' : ''}"
                     onclick="${eq.available > 0 ? `openBorrowModal('${eq.id}')` : 'showToast(\"‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏´‡∏°‡∏î\", \"error\")'}">
                    <div class="text-5xl mb-3 text-center">${eq.icon}</div>
                    <h3 class="font-semibold text-gray-800 text-center text-sm mb-2">${eq.name}</h3>
                    <div class="flex justify-center">
                        <span class="px-3 py-1 ${eq.available > 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'} rounded-full text-xs font-medium">
                            ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${eq.available}/${eq.total}
                        </span>
                    </div>
                    ${eq.available === 0 ? '<div class="absolute inset-0 bg-white/60 rounded-2xl flex items-center justify-center"><span class="text-red-600 font-bold">‡∏´‡∏°‡∏î</span></div>' : ''}
                </div>
            `).join('');
        }

        // Tab Navigation
        function switchTab(tab) {
            ['borrow', 'return', 'history'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
                document.getElementById(`tab-${t}`).classList.add('bg-gray-100');
                document.getElementById(`content-${t}`).classList.add('hidden');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('bg-gray-100');
            document.getElementById(`content-${tab}`).classList.remove('hidden');

            if (tab === 'return') renderReturnList();
            if (tab === 'history') renderHistory();
        }

        // Borrow Modal
        function openBorrowModal(equipmentId) {
            selectedEquipment = currentEquipment.find(e => e.id === equipmentId);
            if (!selectedEquipment) return;

            document.getElementById('selected-equipment-id').value = equipmentId;
            document.getElementById('modal-equipment-name').textContent = `${selectedEquipment.icon} ${selectedEquipment.name}`;
            document.getElementById('borrow-quantity').value = 1;
            document.getElementById('borrow-quantity').max = selectedEquipment.available;
            document.getElementById('available-count').textContent = `(‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${selectedEquipment.available} ‡∏ä‡∏¥‡πâ‡∏ô)`;
            document.getElementById('borrow-modal').classList.remove('hidden');
        }

        function closeBorrowModal() {
            document.getElementById('borrow-modal').classList.add('hidden');
            document.getElementById('borrow-form').reset();
        }

        function adjustQuantity(delta) {
            const input = document.getElementById('borrow-quantity');
            const newVal = parseInt(input.value) + delta;
            if (newVal >= 1 && newVal <= selectedEquipment.available) {
                input.value = newVal;
            }
        }

        // Submit Borrow
        async function submitBorrow(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-borrow-btn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const equipmentId = document.getElementById('selected-equipment-id').value;
            const equipment = currentEquipment.find(eq => eq.id === equipmentId);

            const record = {
                equipmentId,
                equipmentName: equipment.name,
                equipmentIcon: equipment.icon,
                studentName: document.getElementById('student-name').value,
                studentId: document.getElementById('student-id').value,
                quantity: parseInt(document.getElementById('borrow-quantity').value),
                returnDate: document.getElementById('return-date').value,
                borrowDate: new Date().toISOString(),
                status: 'borrowed',
                returnPhoto: null,
                actualReturnDate: null
            };

            try {
                if (isFirebaseInitialized) {
                    const docRef = await db.collection('borrowRecords').add(record);
                    record.id = docRef.id;
                } else {
                    record.id = 'local_' + Date.now();
                }

                borrowRecords.push(record);
                equipment.available -= record.quantity;
                renderEquipment();
                closeBorrowModal();
                showToast('‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (error) {
                console.error("Error:", error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°';
        }

        // Return List
        function renderReturnList() {
            const list = document.getElementById('return-list');
            const borrowedItems = borrowRecords.filter(r => r.status === 'borrowed');

            if (borrowedItems.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-2xl">
                        <div class="text-6xl mb-4">üì¶</div>
                        <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô</p>
                        <p class="text-gray-400 text-sm mt-2">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö "‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏°</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = borrowedItems.map(record => `
                <div class="bg-white rounded-xl p-4 shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="text-4xl">${record.equipmentIcon}</div>
                            <div>
                                <h4 class="font-semibold text-gray-800">${record.equipmentName} x${record.quantity}</h4>
                                <p class="text-sm text-gray-500">${record.studentName} (${record.studentId})</p>
                                <p class="text-xs text-gray-400">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatDate(record.returnDate)}</p>
                            </div>
                        </div>
                        <button onclick="openReturnModal('${record.id}')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                            ‡∏Ñ‡∏∑‡∏ô
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Return Modal
        function openReturnModal(borrowId) {
            const record = borrowRecords.find(r => r.id === borrowId);
            if (!record) return;

            document.getElementById('return-borrow-id').value = borrowId;
            document.getElementById('return-modal-info').textContent = `${record.equipmentIcon} ${record.equipmentName} x${record.quantity}`;
            document.getElementById('photo-preview-container').classList.add('hidden');
            document.getElementById('photo-btn-text').textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
            document.getElementById('return-form').reset();
            document.getElementById('return-modal').classList.remove('hidden');
        }

        function closeReturnModal() {
            document.getElementById('return-modal').classList.add('hidden');
            document.getElementById('return-form').reset();
        }

        function previewReturnPhoto(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('photo-preview').src = event.target.result;
                    document.getElementById('photo-preview-container').classList.remove('hidden');
                    document.getElementById('photo-btn-text').textContent = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ';
                };
                reader.readAsDataURL(file);
            }
        }

        // Submit Return - Fixed
        async function submitReturn() {
            const btn = document.getElementById('submit-return-btn');
            
            // Validation
            const borrowId = document.getElementById('return-borrow-id').value;
            const photoFile = document.getElementById('return-photo').files[0];
            
            if (!borrowId) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', 'error');
                return;
            }

            if (!photoFile) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error');
                return;
            }

            const recordIndex = borrowRecords.findIndex(r => r.id === borrowId);
            if (recordIndex === -1) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                // Convert to base64
                const photoBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(photoFile);
                });

                // Update record
                const record = borrowRecords[recordIndex];
                record.status = 'pending';
                record.returnPhoto = photoBase64;
                record.actualReturnDate = new Date().toISOString();

                // Save to Firebase if available
                if (isFirebaseInitialized && db) {
                    try {
                        await db.collection('borrowRecords').doc(borrowId).update({
                            status: 'pending',
                            returnPhoto: photoBase64,
                            actualReturnDate: record.actualReturnDate
                        });
                    } catch (fbError) {
                        console.warn('Firebase save warning - data saved locally:', fbError.message);
                    }
                }

                closeReturnModal();
                renderReturnList();
                showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
                
            } catch (error) {
                console.error("Submit return error:", error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô';
            }
        }

        // History
        function renderHistory() {
            const list = document.getElementById('history-list');
            const searchTerm = document.getElementById('history-search').value.toLowerCase();
            
            let filtered = borrowRecords;
            if (searchTerm) {
                filtered = borrowRecords.filter(r => 
                    r.studentId.toLowerCase().includes(searchTerm) ||
                    r.studentName.toLowerCase().includes(searchTerm)
                );
            }

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-2xl">
                        <div class="text-6xl mb-4">üìã</div>
                        <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = filtered.map(record => `
                <div class="bg-white rounded-xl p-4 shadow-md">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center gap-3">
                            <div class="text-4xl">${record.equipmentIcon}</div>
                            <div>
                                <h4 class="font-semibold text-gray-800">${record.equipmentName} x${record.quantity}</h4>
                                <p class="text-sm text-gray-600">${record.studentName} (${record.studentId})</p>
                                <p class="text-xs text-gray-400">‡∏¢‡∏∑‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDate(record.borrowDate)}</p>
                                <p class="text-xs text-gray-400">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatDate(record.returnDate)}</p>
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(record.status)}">
                            ${getStatusText(record.status)}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function filterHistory() {
            renderHistory();
        }

        // Admin Panel
        function toggleAdminPanel() {
            const panel = document.getElementById('admin-panel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                renderAdminList();
            }
        }

        function filterAdmin(filter) {
            currentAdminFilter = filter;
            document.querySelectorAll('.admin-filter').forEach(btn => {
                btn.classList.remove('bg-gray-800', 'text-white');
                btn.classList.add('bg-gray-100');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.remove('bg-gray-100');
            document.querySelector(`[data-filter="${filter}"]`).classList.add('bg-gray-800', 'text-white');
            renderAdminList();
        }

        function renderAdminList() {
            const list = document.getElementById('admin-list');
            let filtered = borrowRecords;

            if (currentAdminFilter !== 'all') {
                filtered = borrowRecords.filter(r => r.status === currentAdminFilter);
            }

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üìã</div>
                        <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = filtered.map(record => `
                <div class="p-4 border-b hover:bg-gray-50">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <div class="text-3xl">${record.equipmentIcon}</div>
                            <div>
                                <h4 class="font-semibold text-gray-800">${record.equipmentName} x${record.quantity}</h4>
                                <p class="text-sm text-gray-600">${record.studentName}</p>
                                <p class="text-xs text-gray-500">‡∏£‡∏´‡∏±‡∏™: ${record.studentId}</p>
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(record.status)}">
                            ${getStatusText(record.status)}
                        </span>
                    </div>
                    <div class="text-xs text-gray-400 mb-2">
                        <p>‡∏¢‡∏∑‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDateTime(record.borrowDate)}</p>
                        <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatDate(record.returnDate)}</p>
                        ${record.actualReturnDate ? `<p>‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDateTime(record.actualReturnDate)}</p>` : ''}
                    </div>
                    ${record.returnPhoto ? `
                        <div class="mb-2">
                            <button onclick="showImage('${record.returnPhoto.replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
                                üì∑ ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô
                            </button>
                        </div>
                    ` : ''}
                    ${record.status === 'pending' ? `
                        <button onclick="approveReturn('${record.id}')" class="w-full py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors">
                            ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        function approveReturn(borrowId) {
            const record = borrowRecords.find(r => r.id === borrowId);
            if (!record) return;

            const equipment = currentEquipment.find(e => e.id === record.equipmentId);

            record.status = 'approved';
            equipment.available += record.quantity;

            if (isFirebaseInitialized && db) {
                try {
                    db.collection('borrowRecords').doc(borrowId).update({
                        status: 'approved'
                    });
                } catch (error) {
                    console.error("Firebase update error:", error);
                }
            }

            renderAdminList();
            renderEquipment();
            showToast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }

        // Image Modal
        function showImage(url) {
            document.getElementById('preview-image').src = url;
            document.getElementById('image-modal').classList.remove('hidden');
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.add('hidden');
        }

        // Load Records from Firebase
        async function loadBorrowRecords() {
            if (!isFirebaseInitialized) {
                console.log("Firebase not initialized, using local storage only");
                return;
            }

            try {
                const snapshot = await db.collection('borrowRecords').get();
                borrowRecords = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    borrowRecords.push(data);

                    // Update equipment availability
                    if (data.status === 'borrowed' || data.status === 'pending') {
                        const eq = currentEquipment.find(e => e.id === data.equipmentId);
                        if (eq) {
                            eq.available -= data.quantity;
                        }
                    }
                });

                console.log("Loaded " + borrowRecords.length + " records from Firebase");
                renderEquipment();
            } catch (error) {
                console.error("Error loading records:", error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase', 'error');
            }
        }

        // Helper Functions
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', { 
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function getStatusClass(status) {
            const classes = {
                borrowed: 'status-borrowed',
                pending: 'status-pending',
                approved: 'status-approved',
                returned: 'status-returned'
            };
            return classes[status] || 'bg-gray-100 text-gray-700';
        }

        function getStatusText(status) {
            const texts = {
                borrowed: 'üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°',
                pending: '‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                approved: '‚úÖ ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                returned: '‚úÖ ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
            };
            return texts[status] || status;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            
            toast.className = `toast ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Initialize
        initApp();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cd2c942a4789cf6',t:'MTc3MDk2OTU2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
